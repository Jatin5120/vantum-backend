# WebSocket Protocol Specification

**Version**: 1.0.0  
**Last Updated**: 2025-12-17  
**Status**: Single Source of Truth

This document defines the complete WebSocket protocol specification for the Vantum backend. All implementations must follow these specifications exactly.

## Quick Start

**New to the protocol?** Start here:

1. Read [Base Message Structure](#base-message-structure) to understand the common format
2. Review [Message Types](#message-types) to see request/response patterns
3. Check [Complete Examples](#complete-examples) for real-world usage
4. Use [Quick Reference Guide](./websocket-quick-reference.md) for fast lookup

**Key Points**:

- All fields use **camelCase** (`eventType`, `eventId`, `sessionId`)
- All messages require 4 fields: `eventType`, `eventId`, `sessionId`, `payload`
- Responses echo back the same `eventId` and `sessionId` from the request
- Error responses include `requestType` at top level

## Table of Contents

1. [Base Message Structure](#base-message-structure)
2. [Message Types](#message-types)
   - [Request Messages](#1-request-messages-client--server)
   - [ACK Response Messages](#2-ack-response-messages-server--client)
   - [Regular Response Messages](#3-regular-response-messages-server--client)
   - [Error Response Messages](#4-error-response-messages-server--client)
   - [Connection ACK](#5-connection-ack-special-case)
3. [Field Requirements](#field-requirements)
4. [Validation Rules](#validation-rules)
5. [Event Types](#event-types)
6. [Message Flow Examples](#message-flow-examples)
7. [Complete Examples](#complete-examples)
8. [Implementation Notes](#implementation-notes)

---

## Base Message Structure

All WebSocket messages (requests and responses) follow this structure:

```typescript
interface BaseMessage {
  eventType: string; // REQUIRED - Event type identifier
  eventId: string; // REQUIRED - UUIDv7 for this event
  sessionId: string; // REQUIRED - Session ID (UUIDv7, same for one session)
  payload: unknown; // REQUIRED - Event-specific data
}
```

### Field Descriptions

- **`eventType`** (string, required): Event type identifier (e.g., `"voicechat.audio.start"`, `"voicechat.response.chunk"`)
- **`eventId`** (string, required): Unique identifier for this event (UUIDv7 format, time-ordered)
- **`sessionId`** (string, required): Session identifier (UUIDv7 format, same for all events in a session)
- **`payload`** (object, required): Event-specific data structure

### Naming Convention

**All field names use camelCase:**

- ✅ `eventType` (not `event_type`)
- ✅ `eventId` (not `event_id`)
- ✅ `sessionId` (not `session_id`)
- ✅ `requestType` (not `request_type`)
- ✅ `utteranceId` (not `utterance_id`)
- ✅ `sampleRate` (not `sample_rate`)

---

## Message Types

### 1. Request Messages (Client → Server)

Request messages are sent by the client to initiate actions or send data.

**Format:**

- `eventType`: Request event type (e.g., `"voicechat.audio.start"`)
- `eventId`: UUIDv7 generated by client (unique per request)
- `sessionId`: UUIDv7 session ID (same for all events in a session)
- `payload`: Request-specific data

**Example:**

```typescript
{
  eventType: "voicechat.audio.start",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",
  sessionId: "01234567-89ab-cdef-0123-456789abcdef",
  payload: {
    samplingRate: 16000,
    language: "en-US",
    voiceId: "default"
  }
}
```

**Note:** All requests must be sent after WebSocket connection is established. The client receives `connection.ack` first, then sends requests with the `sessionId` from that ACK.

---

### 2. ACK Response Messages (Server → Client)

ACK responses acknowledge successful processing of a request.

**Format:**

- `eventType`: **Same as request** (echoed back)
- `eventId`: **Same as request** (echoed back)
- `sessionId`: **Same as request** (echoed back)
- `payload`: `{ success: true }`

**Example:**

```typescript
{
  eventType: "voicechat.audio.start",  // Same as request
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  payload: {
    success: true
  }
}
```

**When ACKs are sent:**

- ✅ ACK for `voicechat.audio.start` (after session initialization)
- ✅ ACK for `voicechat.audio.end` (after session cleanup)
- ❌ **No ACK for `voicechat.audio.chunk`** (streaming events don't get ACKs)

**If validation fails:** Send an error response (not an ACK).

---

### 3. Regular Response Messages (Server → Client)

Regular responses are sent by the server to provide data or signal events.

**Format:**

- `eventType`: Response event type (e.g., `"voicechat.response.start"`)
- `eventId`: **Same as original request** `eventId` (echoed back for correlation)
- `sessionId`: **Same as original request** `sessionId` (echoed back)
- `payload`: Response-specific data

**Response Types:**

- `voicechat.response.start` - AI about to respond
- `voicechat.response.complete` - AI response complete
- `voicechat.response.interrupt` - User interrupted AI
- `voicechat.response.stop` - Stop in-flight response
- `voicechat.response.chunk` - TTS audio chunk (see special format below)

**Example - Response Start:**

```typescript
{
  eventType: "voicechat.response.start",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  payload: {
    utteranceId: "01234567-89ab-cdef-0123-456789abcdef",
    timestamp: 1234567890
  }
}
```

**Example - Response Complete:**

```typescript
{
  eventType: "voicechat.response.complete",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  payload: {
    utteranceId: "01234567-89ab-cdef-0123-456789abcdef"
  }
}
```

#### Response Chunks (Special Format)

**Critical:** All chunks for the same response share the **same `eventId`**, but each chunk has a **unique `utteranceId`** (time-ordered UUIDv7) used for ordering.

**Format:**

- `eventType`: `"voicechat.response.chunk"`
- `eventId`: **Same for all chunks** (from original request)
- `sessionId`: **Same for all chunks** (from original request)
- `payload`: Contains unique `utteranceId` per chunk

**Example - Multiple Chunks:**

```typescript
// Chunk 1
{
  eventType: "voicechat.response.chunk",
  eventId: "req-123",  // SAME for all chunks
  sessionId: "sess-456",
  payload: {
    audio: Uint8Array,
    utteranceId: "utt-001",  // UNIQUE per chunk, time-ordered UUIDv7
    sampleRate: 16000
  }
}

// Chunk 2
{
  eventType: "voicechat.response.chunk",
  eventId: "req-123",  // SAME as chunk 1
  sessionId: "sess-456",
  payload: {
    audio: Uint8Array,
    utteranceId: "utt-002",  // UNIQUE, different from chunk 1
    sampleRate: 16000
  }
}

// Chunk 3
{
  eventType: "voicechat.response.chunk",
  eventId: "req-123",  // SAME as chunks 1 and 2
  sessionId: "sess-456",
  payload: {
    audio: Uint8Array,
    utteranceId: "utt-003",  // UNIQUE, different from chunks 1 and 2
    sampleRate: 16000
  }
}
```

**Key Points:**

- ✅ Same `eventId` for all chunks (correlates to original request)
- ✅ Unique `utteranceId` per chunk (time-ordered UUIDv7 for ordering)
- ✅ No `sequenceNumber` field (replaced by unique `utteranceId`)
- ✅ Client orders chunks by `utteranceId` (UUIDv7 is time-ordered)

---

### 4. Error Response Messages (Server → Client)

Error responses indicate that a request failed or was invalid.

**Format:**

- `eventType`: Converted using `toErrorEventType(requestType)` (e.g., `"voicechat.audio.error"`)
- `eventId`: **Same as original request** `eventId` (echoed back)
- `sessionId`: **Same as original request** `sessionId` (echoed back)
- `requestType`: **Original request `eventType`** (at top level, not in payload)
- `payload`: `{ message: string }` (only error message)

**Example:**

```typescript
{
  eventType: "voicechat.audio.error",  // Converted from "voicechat.audio.start"
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  requestType: "voicechat.audio.start",  // Original eventType - AT TOP LEVEL
  payload: {
    message: "Invalid sampling rate: must be between 8000 and 48000"
  }
}
```

**Error Event Type Conversion:**

- `toErrorEventType("voicechat.audio.start")` → `"voicechat.audio.error"`
- `toErrorEventType("voicechat.response.start")` → `"voicechat.response.error"`
- `toErrorEventType("chat.message.send")` → `"chat.message.error"`
- `toErrorEventType("audio.start")` → `"audio.error"`

**Malformed Requests:**

- If `eventType` is missing: Use `"error.unknown"` as `eventType`
- `requestType` in payload: Use `null` or the malformed value if available

**Key Points:**

- ✅ `requestType` is at **top level** (same level as `eventType`, `eventId`, `sessionId`)
- ✅ `payload` contains **only** `{ message: string }`
- ✅ No error code, timestamp, or other fields in payload

---

### 5. Connection ACK (Special Case)

Connection ACK is sent automatically by the server when a WebSocket connection is established.

**Format:**

- `eventType`: `"connection.ack"`
- `eventId`: **New UUIDv7** (generated by server, not a response to a request)
- `sessionId`: **Server-generated session ID** (UUIDv7)
- `payload`: `{ success: true }`

**Example:**

```typescript
{
  eventType: "connection.ack",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // New UUIDv7
  sessionId: "01234567-89ab-cdef-0123-456789abcdef",  // Server-generated
  payload: {
    success: true
  }
}
```

**Note:** This is **not** a response to a client request. It's sent automatically on connection establishment.

---

## Field Requirements

| Field         | Request                  | ACK Response           | Regular Response   | Error Response           | Connection ACK         |
| ------------- | ------------------------ | ---------------------- | ------------------ | ------------------------ | ---------------------- |
| `eventType`   | ✅ Required              | ✅ Same as request     | ✅ Response type   | ✅ Converted error type  | ✅ `"connection.ack"`  |
| `eventId`     | ✅ Required (new UUIDv7) | ✅ Same as request     | ✅ Same as request | ✅ Same as request       | ✅ New UUIDv7          |
| `sessionId`   | ✅ Required              | ✅ Same as request     | ✅ Same as request | ✅ Same as request       | ✅ Server-generated    |
| `requestType` | ❌                       | ❌                     | ❌                 | ✅ Required (top level)  | ❌                     |
| `payload`     | ✅ Required              | ✅ `{ success: true }` | ✅ Response data   | ✅ `{ message: string }` | ✅ `{ success: true }` |

---

## Validation Rules

1. **Required Fields:** All messages must have all four base fields (`eventType`, `eventId`, `sessionId`, `payload`)
2. **Missing Fields:** If required fields are missing, send error response with `eventType: "error.unknown"`
3. **UUID Format:** `eventId` and `sessionId` must be valid UUIDv7 format
4. **Session ID Validation:** `sessionId` is client-generated (UUIDv7 format), no server-side validation of ownership
5. **Duplicate Event IDs:** Server accepts duplicate `eventId` values (client responsibility to ensure uniqueness)

---

## Event Types

This section lists all event types. For detailed specifications, see the [Message Types](#message-types) section above.

### Client → Server Events

- `voicechat.audio.start` - Initialize voice session (see [Request Messages](#1-request-messages-client--server))
- `voicechat.audio.chunk` - Stream audio chunk (see [Request Messages](#1-request-messages-client--server))
- `voicechat.audio.end` - End voice session (see [Request Messages](#1-request-messages-client--server))

### Server → Client Events

- `connection.ack` - Connection acknowledgment (see [Connection ACK](#5-connection-ack-special-case))
- `voicechat.response.start` - AI about to respond (see [Regular Response Messages](#3-regular-response-messages-server--client))
- `voicechat.response.chunk` - TTS audio chunk (see [Response Chunks](#response-chunks-special-format))
- `voicechat.response.complete` - AI response complete (see [Regular Response Messages](#3-regular-response-messages-server--client))
- `voicechat.response.interrupt` - User interrupted AI (see [Regular Response Messages](#3-regular-response-messages-server--client))
- `voicechat.response.stop` - Stop in-flight response (see [Regular Response Messages](#3-regular-response-messages-server--client))
- `voicechat.audio.error` - Error for audio events (see [Error Response Messages](#4-error-response-messages-server--client))
- `voicechat.response.error` - Error for response events (see [Error Response Messages](#4-error-response-messages-server--client))
- `error.unknown` - Generic error for malformed messages (see [Error Response Messages](#4-error-response-messages-server--client))

---

## Message Flow Examples

```mermaid
sequenceDiagram
    participant Client
    participant Server

    Note over Client,Server: Connection Establishment
    Client->>Server: WebSocket Connect
    Server->>Client: connection.ack<br/>(new eventId, server sessionId)

    Note over Client,Server: Request-Response Flow
    Client->>Server: voicechat.audio.start<br/>(eventId: req-123, sessionId: sess-456)
    Server->>Client: ACK<br/>(same eventId: req-123, sessionId: sess-456)

    Note over Client,Server: Streaming Chunks
    Client->>Server: voicechat.audio.chunk<br/>(eventId: req-124)
    Note over Server: Processes and generates response
    Server->>Client: response.start<br/>(same eventId: req-124)
    Server->>Client: response.chunk<br/>(same eventId: req-124, utteranceId: utt-1)
    Server->>Client: response.chunk<br/>(same eventId: req-124, utteranceId: utt-2)
    Server->>Client: response.chunk<br/>(same eventId: req-124, utteranceId: utt-3)
    Server->>Client: response.complete<br/>(same eventId: req-124)

    Note over Client,Server: Error Flow
    Client->>Server: Invalid request<br/>(eventId: req-125)
    Server->>Client: Error<br/>(eventType: "*.error", requestType at top level)
```

---

## Complete Examples

### Example 1: Connection Establishment

**Client:** Establishes WebSocket connection

**Server Response:**

```typescript
{
  eventType: "connection.ack",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    success: true
  }
}
```

---

### Example 2: Audio Session Start

**Client Request:**

```typescript
{
  eventType: "voicechat.audio.start",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    samplingRate: 16000,
    language: "en-US",
    voiceId: "default"
  }
}
```

**Server ACK:**

```typescript
{
  eventType: "voicechat.audio.start",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",  // Same as request
  payload: {
    success: true
  }
}
```

---

### Example 3: Streaming Response with Chunks

**Client Request:**

```typescript
{
  eventType: "voicechat.audio.chunk",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    audio: Uint8Array,
    isMuted: false
  }
}
```

**Server Responses (same eventId, unique utteranceId per chunk):**

```typescript
// Response start
{
  eventType: "voicechat.response.start",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    utteranceId: "11111111-1111-1111-1111-111111111111",
    timestamp: 1234567890
  }
}

// Chunk 1
{
  eventType: "voicechat.response.chunk",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    audio: Uint8Array,
    utteranceId: "22222222-2222-2222-2222-222222222222",  // Unique
    sampleRate: 16000
  }
}

// Chunk 2
{
  eventType: "voicechat.response.chunk",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    audio: Uint8Array,
    utteranceId: "33333333-3333-3333-3333-333333333333",  // Unique, different from chunk 1
    sampleRate: 16000
  }
}

// Response complete
{
  eventType: "voicechat.response.complete",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    utteranceId: "11111111-1111-1111-1111-111111111111"
  }
}
```

---

### Example 4: Error Handling

**Client Request (Invalid):**

```typescript
{
  eventType: "voicechat.audio.start",
  eventId: "01234567-89ab-cdef-0123-456789abcdef",
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",
  payload: {
    samplingRate: 5000  // Invalid: below minimum
  }
}
```

**Server Error Response:**

```typescript
{
  eventType: "voicechat.audio.error",  // Converted from "voicechat.audio.start"
  eventId: "01234567-89ab-cdef-0123-456789abcdef",  // Same as request
  sessionId: "fedcba98-7654-3210-fedc-ba9876543210",  // Same as request
  requestType: "voicechat.audio.start",  // Original eventType - AT TOP LEVEL
  payload: {
    message: "Invalid sampling rate: must be between 8000 and 48000"
  }
}
```

---

## Implementation Notes

1. **Session ID:** Always at top level, never in `payload`
2. **Event ID Correlation:** Regular responses and errors echo the request `eventId`
3. **Server-Initiated Events:** For events not tied to a request, generate new `eventId` (UUIDv7)
4. **Chunk Ordering:** Use unique `utteranceId` per chunk (time-ordered UUIDv7) instead of `sequenceNumber`
5. **Error Event Type Conversion:** Generic and scalable (works for any event type prefix)
6. **Request Type in Errors:** Always at top level, not in `payload`

---

## See Also

- [WebSocket Quick Reference](./websocket-quick-reference.md) - One-page quick lookup
- [API Documentation](../api/api.md) - REST + WebSocket overview
- [Architecture Documentation](../architecture/architecture.md) - System architecture
- [Documentation Index](../README.md) - All documentation files

---

**This document is the single source of truth for WebSocket message formats in the Vantum project. All implementations must follow these specifications exactly.**
